name: CI

on: [push, pull_request]

env:
  DEVELOPER: 1

jobs:
  dockerized:
    name: ${{matrix.vector.jobname}} (${{matrix.vector.image}})
    strategy:
      fail-fast: false
      matrix:
        vector:
        - jobname: linux32
          os: ubuntu32
          image: daald/ubuntu32:xenial
    env:
      jobname: ${{matrix.vector.jobname}}
    runs-on: ubuntu-latest
    container: ${{matrix.vector.image}}
    steps:
    - uses: actions/checkout@v3
      if: matrix.vector.jobname != 'linux32'
    - uses: actions/checkout@v1
      if: matrix.vector.jobname == 'linux32'
    - run: ci/install-docker-dependencies.sh
    - run: ci/run-build-and-tests.sh
    - name: print test failures
      if: failure() && env.FAILED_TEST_ARTIFACTS != ''
      shell: bash
      run: ci/print-test-failures.sh
    - name: Upload failed tests' directories
      if: failure() && env.FAILED_TEST_ARTIFACTS != ''
      uses: actions/upload-artifact@v1
      with:
        name: failed-tests-${{matrix.vector.jobname}}
        path: ${{env.FAILED_TEST_ARTIFACTS}}
